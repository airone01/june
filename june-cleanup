#!/usr/bin/env bash
# june-cleanup - Clean up old junest installations and reset june
# Use this if you have issues with existing junest installations

set -euo pipefail

echo "This will clean up all junest installations and june data."
echo "You will need to reinstall all packages after this."
read -p "Continue? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Cancelled."
    exit 0
fi

echo "Cleaning up junest installations..."

# Remove default junest location
if [[ -d "$HOME/.junest" ]]; then
    echo "Removing ~/.junest..."
    rm -rf "$HOME/.junest"
fi

# Remove goinfre junest
if [[ -d "$HOME/goinfre/junest-root" ]]; then
    echo "Removing ~/goinfre/junest-root..."
    rm -rf "$HOME/goinfre/junest-root"
fi

# Remove sgoinfre archive
if [[ -f "$HOME/sgoinfre/junest-root.tar.zst" ]]; then
    echo "Removing sgoinfre archive..."
    rm -f "$HOME/sgoinfre/junest-root.tar.zst"
fi

# Remove state files
rm -f "$HOME/goinfre/june-state.db"
rm -f "$HOME/sgoinfre/june-state.db"
rm -f "$HOME/sgoinfre/.junest.lock"
rm -f "$HOME/goinfre/june-startup.log"

# Remove shims
if [[ -d "$HOME/bin" ]]; then
    echo "Removing june shims..."
    for shim in "$HOME/bin"/*; do
        if [[ -f "$shim" ]] && grep -q "#june-shim" "$shim" 2>/dev/null; then
            rm -f "$shim"
            echo "  Removed: $(basename "$shim")"
        fi
    done
fi

echo "Cleanup complete!"
echo ""
echo "You can now run june-startup to initialize a fresh environment."
